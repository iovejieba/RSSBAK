name: Simple RSS Backup

on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯2å°æ—¶ä¸€æ¬¡
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆå®Œå…¨æ£€å‡ºï¼‰
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ£€å‡ºå®Œæ•´å†å²
      
      # 2. è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆåœ¨è¿™é‡Œä¿®æ”¹ä½ çš„RSSé“¾æ¥ï¼‰
      - name: Setup variables
        run: |
          echo "RSS_URL=https://rsshub.995299.xyz:8443/javbees/new" >> $GITHUB_ENV
          echo "XML_FILE=feeds/javbee.xml" >> $GITHUB_ENV
          echo "TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
      
      # 3. è·å–RSSå¹¶ä¿å­˜
      - name: Fetch RSS
        run: |
          # åˆ›å»ºç›®å½•
          mkdir -p feeds
          
          echo "æ­£åœ¨æŠ“å–: ${{ env.RSS_URL }}"
          
          # æŠ“å–RSSï¼ˆå¸¦ç”¨æˆ·ä»£ç†å’Œé‡è¯•ï¼‰
          curl -s -L -A "Mozilla/5.0 (RSS-Backup/1.0)" \
            "${{ env.RSS_URL }}" -o "${{ env.XML_FILE }}"
          
          # æ£€æŸ¥æ˜¯å¦æŠ“å–æˆåŠŸ
          if [ ! -s "${{ env.XML_FILE }}" ]; then
            echo "é”™è¯¯: æŠ“å–çš„æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          
          # æ·»åŠ æ—¶é—´æˆ³æ³¨é‡Š
          echo "<!-- æœ€åæ›´æ–°: ${{ env.TIMESTAMP }} -->" | cat - "${{ env.XML_FILE }}" > temp.xml
          mv temp.xml "${{ env.XML_FILE }}"
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "âœ… æŠ“å–å®Œæˆ"
          echo "æ–‡ä»¶: ${{ env.XML_FILE }}"
          echo "å¤§å°: $(wc -l < "${{ env.XML_FILE }}") è¡Œ"
          echo "æœ€å10è¡Œå†…å®¹:"
          tail -10 "${{ env.XML_FILE }}"
      
      # 4. é…ç½®Git
      - name: Configure Git
        run: |
          git config --local user.email "rss-bot@users.noreply.github.com"
          git config --local user.name "RSS Backup Bot"
          git config --global --add safe.directory /github/workspace
      
      # 5. æ£€æŸ¥æ›´æ”¹å¹¶æäº¤
      - name: Check for changes
        id: check_changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "å‘ç°æ›´æ”¹"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "æ²¡æœ‰æ›´æ”¹"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      # 6. æäº¤æ›´æ”¹
      - name: Commit and push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "æäº¤æ›´æ”¹..."
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add -A
          
          # æäº¤
          git commit -m "ğŸ“° RSSå¤‡ä»½ $(date '+%Y-%m-%d %H:%M:%S')
          
          - æ–‡ä»¶: ${{ env.XML_FILE }}
          - æ—¶é—´: ${{ env.TIMESTAMP }}
          - æº: ${{ env.RSS_URL }}"
          
          # æ¨é€
          git push
          
          echo "âœ… å·²æäº¤åˆ°ä»“åº“"
      
      # 7. æ— æ›´æ”¹æ—¶é€šçŸ¥
      - name: No changes
        if: steps.check_changes.outputs.has_changes == 'false'
        run: echo "ğŸ¤· æ²¡æœ‰å‘ç°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
